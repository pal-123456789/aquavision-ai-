{% extends "layout.html" %}

{% block title %}Historical Data{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row mb-4">
        <div class="col">
            <h1><i class="fas fa-history me-3"></i>Historical Bloom Data</h1>
            <p class="lead">Explore past algal bloom occurrences and trends</p>
        </div>
    </div>
    
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-body">
                    <h5 class="card-title"><i class="fas fa-globe-americas me-2"></i>Global Hotspots</h5>
                    <div id="historicalMap" style="height: 300px;"></div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-body">
                    <h5 class="card-title"><i class="fas fa-filter me-2"></i>Filter Data</h5>
                    <form id="historyFilterForm">
                        <div class="mb-3">
                            <label for="regionSelect" class="form-label">Region</label>
                            <select class="form-select" id="regionSelect">
                                <option value="all">All Regions</option>
                                <option value="north_america">North America</option>
                                <option value="europe">Europe</option>
                                <option value="asia">Asia</option>
                                <option value="south_america">South America</option>
                                <option value="africa">Africa</option>
                                <option value="oceania">Oceania</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="dateRange" class="form-label">Date Range</label>
                            <input type="text" class="form-control" id="dateRange" placeholder="Select date range">
                        </div>
                        <div class="mb-3">
                            <label for="severitySelect" class="form-label">Severity</label>
                            <select class="form-select" id="severitySelect" multiple>
                                <option value="low" selected>Low</option>
                                <option value="medium" selected>Medium</option>
                                <option value="high" selected>High</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-search me-2"></i>Apply Filters
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title"><i class="fas fa-chart-line me-2"></i>Bloom Trends</h5>
                    <canvas id="globalTrendChart" height="100"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mt-4">
        <div class="col">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-table me-2"></i>Historical Records</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="historyTable">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Location</th>
                                    <th>Severity</th>
                                    <th>Area (kmÂ²)</th>
                                    <th>Duration</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Data will be loaded dynamically -->
                            </tbody>
                        </table>
                    </div>
                    <nav aria-label="History pagination">
                        <ul class="pagination justify-content-center mt-3">
                            <li class="page-item disabled">
                                <a class="page-link" href="#" tabindex="-1">Previous</a>
                            </li>
                            <li class="page-item active"><a class="page-link" href="#">1</a></li>
                            <li class="page-item"><a class="page-link" href="#">2</a></li>
                            <li class="page-item"><a class="page-link" href="#">3</a></li>
                            <li class="page-item">
                                <a class="page-link" href="#">Next</a>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        // Initialize map
        const historicalMap = L.map('historicalMap').setView([20, 0], 2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(historicalMap);
        
        // Fix map display
        setTimeout(() => historicalMap.invalidateSize(), 300);

        // Load data with error handling
        function loadHistoryData() {
            fetch('/history-data')
                .then(response => {
                    if (!response.ok) throw new Error('Network error');
                    return response.json();
                })
                .then(data => {
                    if (!data.success) throw new Error(data.error || 'Unknown error');
                    renderCharts(data);
                })
                .catch(error => {
                    console.error("Error:", error);
                    alert("Failed to load history data. Please try again.");
                });
        }

        function renderCharts(data) {
            // Chart.js initialization with error boundaries
            try {
                new Chart(
                    document.getElementById('globalTrendChart').getContext('2d'),
                    {
                        type: 'line',
                        data: {
                            labels: data.trend_labels,
                            datasets: [{
                                label: 'Bloom Occurrences',
                                data: data.trend_data,
                                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                                borderColor: 'rgba(54, 162, 235, 1)'
                            }]
                        }
                    }
                );
            } catch (e) {
                console.error("Chart error:", e);
            }
            
            // Render timeline
            const timeline = document.querySelector('.timeline');
            if (timeline && data.timeline) {
                timeline.innerHTML = data.timeline.map(item => `
                    <div class="mb-3 p-2 border rounded">
                        <strong>${item.date}</strong>
                        <span class="badge bg-${item.severity === 'High' ? 'danger' : item.severity === 'Medium' ? 'warning' : 'info'}">
                            ${item.severity}
                        </span>
                        <div>${item.description}</div>
                    </div>
                `).join('');
            }
        }

        loadHistoryData();
    });
</script>
{% endblock %}