{% extends "layout.html" %}

{% block content %}
<div class="container-fluid p-0 position-relative" style="height: calc(100vh - 56px - 60px);">
    <div id="map"></div>
    
    <div class="card position-absolute" style="top: 15px; right: 15px; z-index: 1000; width: 300px;">
        <div class="card-body">
            <h5 class="card-title">Analysis Controls</h5>
            <p class="card-text small">Your location is found automatically, or click the map to select a point.</p>
            <div id="status-alert" class="alert alert-info" role="alert">Locating you...</div>
            <div class="d-grid gap-2">
                <button id="detect-btn" class="btn btn-primary" disabled>Detect Current Blooms</button>
                <button id="predict-btn" class="btn btn-warning" disabled>Predict Future Hotspots</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="loadingModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3 mb-0" id="loading-text">Analyzing data...</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const map = L.map('map');
    const detectBtn = document.getElementById('detect-btn');
    const predictBtn = document.getElementById('predict-btn');
    const statusAlert = document.getElementById('status-alert');
    const loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'), { keyboard: false, backdrop: 'static' });
    const loadingText = document.getElementById('loading-text');

    let currentOverlay = null;
    let analysisLocation = null;
    let locationMarker = null;

    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Tiles &copy; Esri'
    }).addTo(map);

    function setStatus(message, type = 'info') {
        statusAlert.className = `alert alert-${type}`;
        statusAlert.innerHTML = message;
    }
    
    function setButtonsState(disabled) {
        detectBtn.disabled = disabled;
        predictBtn.disabled = disabled;
    }

    function addImageOverlay(data) {
        if (currentOverlay) map.removeLayer(currentOverlay);
        currentOverlay = L.imageOverlay(data.image_url, data.bounds).addTo(map);
    }

    function updateLocation(lat, lon, message) {
        analysisLocation = { lat, lon };
        if (locationMarker) {
            locationMarker.setLatLng([lat, lon]);
        } else {
            locationMarker = L.marker([lat, lon]).addTo(map);
        }
        locationMarker.bindPopup(message).openPopup();
        setButtonsState(false);
        setStatus("Location selected. Ready to analyze.", "success");
    }

    function runAnalysis(endpoint, loadingMessage) {
        if (!analysisLocation) return;
        setButtonsState(true);
        loadingText.innerHTML = loadingMessage;
        loadingModal.show();
        const url = `/${endpoint}?lat=${analysisLocation.lat}&lon=${analysisLocation.lon}`;
        
        fetch(url)
            .then(res => res.json())
            .then(data => {
                loadingModal.hide();
                if (data.success) {
                    addImageOverlay(data);
                    setStatus(`${endpoint.charAt(0).toUpperCase() + endpoint.slice(1)} complete!`, 'success');
                } else {
                    setStatus(`Error: ${data.error}`, 'danger');
                }
                setButtonsState(false);
            })
            .catch(err => {
                loadingModal.hide();
                setStatus("A network error occurred.", 'danger');
                setButtonsState(false);
            });
    }

    navigator.geolocation.getCurrentPosition(
        pos => {
            const { latitude: lat, longitude: lon } = pos.coords;
            map.setView([lat, lon], 12);
            updateLocation(lat, lon, "Your Location");
        },
        () => {
            const lat = 21.17, lon = 72.83;
            map.setView([lat, lon], 12);
            updateLocation(lat, lon, "Default Location (Surat, India)");
            setStatus("Could not get location. Click map to choose.", "warning");
        }
    );

    map.on('click', e => updateLocation(e.latlng.lat, e.latlng.lng, `Selected Point`));
    detectBtn.addEventListener('click', () => runAnalysis('detect', 'Detecting current blooms...'));
    predictBtn.addEventListener('click', () => runAnalysis('predict', 'Predicting future hotspots...'));

</script>
{% endblock %}