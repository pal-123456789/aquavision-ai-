<!DOCTYPE html>
<html>
<head>
    <title>AquaVision AI - Real-Time Forecaster</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { font-family: sans-serif; margin: 0; padding: 0; background-color: #f4f4f4; }
        #map { height: 100vh; }
        .info-panel {
            position: absolute; top: 10px; right: 10px; z-index: 1000;
            background: white; padding: 15px; border-radius: 8px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.4); width: 250px;
        }
        button {
            width: 100%; padding: 10px; font-size: 16px; margin-top: 10px;
            cursor: pointer; border: none; border-radius: 5px; color: white;
        }
        #detect-btn { background-color: #007bff; }
        #predict-btn { background-color: #ffc107; color: #333; }
        button:disabled { background-color: #cccccc; cursor: not-allowed; }
        #status { margin-top: 10px; text-align: center; font-style: italic; color: #555; }
    </style>
</head>
<body>
    <div id="map"></div>
    <div class="info-panel">
        <h2>üõ∞Ô∏è AquaVision AI</h2>
        <p>Detects algal blooms. Your location is found automatically, or you can click anywhere on the map to select a new point.</p>
        <button id="detect-btn" disabled>Detect Current Blooms</button>
        <button id="predict-btn" disabled>Predict Future Hotspots</button>
        <div id="status">Locating you...</div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const map = L.map('map');
        const detectBtn = document.getElementById('detect-btn');
        const predictBtn = document.getElementById('predict-btn');
        const statusDiv = document.getElementById('status');
        
        let currentOverlay = null;
        let analysisLocation = null; // Renamed from userLocation for clarity
        let locationMarker = null;   // A variable to hold our marker

        // --- CHANGED: Satellite Map Layer ---
        // We are now using Esri's World Imagery layer instead of OpenStreetMap
        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
        }).addTo(map);

        function setStatus(message) { statusDiv.innerHTML = message; }
        
        function setButtonsState(disabled) {
            detectBtn.disabled = disabled;
            predictBtn.disabled = disabled;
        }

        function addImageOverlay(data) {
            if (currentOverlay) map.removeLayer(currentOverlay);
            currentOverlay = L.imageOverlay(data.image_url, data.bounds).addTo(map);
            // We don't need to fit bounds anymore to allow for free exploration
            // map.fitBounds(data.bounds); 
        }

        // NEW FUNCTION: To update the marker and location
        function updateLocation(lat, lon, message) {
            analysisLocation = { lat, lon };
            
            // If a marker already exists, move it. If not, create it.
            if (locationMarker) {
                locationMarker.setLatLng([lat, lon]);
            } else {
                locationMarker = L.marker([lat, lon]).addTo(map);
            }
            locationMarker.bindPopup(message).openPopup();
            
            setButtonsState(false); // Enable analysis buttons
            setStatus("Location selected. Ready to analyze.");
        }

        // --- Get user's initial location ---
        navigator.geolocation.getCurrentPosition(
            function(position) {
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;
                map.setView([lat, lon], 12); // Zoom in a bit more
                updateLocation(lat, lon, "Your Location");
            },
            function() {
                // If geolocation fails, default to Surat, India
                const lat = 21.17;
                const lon = 72.83;
                map.setView([lat, lon], 12);
                updateLocation(lat, lon, "Default Location (Surat)");
                setStatus("Could not get location. Click map to choose.");
            }
        );

        // --- NEW: Event listener for clicking on the map ---
        map.on('click', function(e) {
            const lat = e.latlng.lat;
            const lon = e.latlng.lng;
            updateLocation(lat, lon, `Selected Point: ${lat.toFixed(4)}, ${lon.toFixed(4)}`);
        });

        // --- Button click handlers (no change in logic) ---
        detectBtn.addEventListener('click', () => {
            if (!analysisLocation) return;
            setButtonsState(true);
            setStatus("Detecting current blooms...");
            const url = `/detect?lat=${analysisLocation.lat}&lon=${analysisLocation.lon}`;
            fetch(url).then(res => res.json()).then(data => {
                if (data.success) { addImageOverlay(data); setStatus("Detection complete!"); } 
                else { setStatus(`Error: ${data.error}`); }
                setButtonsState(false);
            }).catch(err => { setStatus("A network error occurred."); setButtonsState(false); });
        });
        
        predictBtn.addEventListener('click', () => {
            if (!analysisLocation) return;
            setButtonsState(true);
            setStatus("Predicting future hotspots...");
            const url = `/predict?lat=${analysisLocation.lat}&lon=${analysisLocation.lon}`;
            fetch(url).then(res => res.json()).then(data => {
                if (data.success) { addImageOverlay(data); setStatus("Prediction complete!"); } 
                else { setStatus(`Error: ${data.error}`); }
                setButtonsState(false);
            }).catch(err => { setStatus("A network error occurred."); setButtonsState(false); });
        });

    </script>
</body>
</html>