{% extends "layout.html" %}

{% block content %}
<nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow-sm">
    <div class="container-fluid">
        <a class="navbar-brand" href="/" data-link><i class="fas fa-water me-2"></i>AquaVision AI</a>
        <div class="collapse navbar-collapse">
            <ul class="navbar-nav me-auto">
                <li class="nav-item"><a class="nav-link" href="/" data-link>Map</a></li>
                <li class="nav-item"><a class="nav-link" href="/history" data-link>History</a></li>
            </ul>
            <div id="auth-container" class="d-flex align-items-center"></div>
        </div>
    </div>
</nav>

<div class="content-wrapper" id="main-content">
    <div class="d-flex justify-content-center align-items-center h-100">
        <div class="spinner-border text-primary" role="status"></div>
    </div>
</div>

{% include 'auth_modals.html' %}

<div id="loading-overlay" class="position-fixed top-0 start-0 w-100 h-100 bg-dark bg-opacity-75 d-flex justify-content-center align-items-center d-none" style="z-index: 1100;">
    <div class="text-center text-white">
        <div class="spinner-border" style="width: 3rem; height: 3rem;"></div>
        <h4 class="mt-3">Processing Analysis...</h4>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- STATE MANAGEMENT ---
    const state = {
        currentUser: null,
        isAuthenticated: false,
    };

    // --- API HELPER ---
    async function apiRequest(url, options = {}) {
        const response = await fetch(url, options);
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
        }
        return response.json();
    }

    // --- VIEWS ---
    class AbstractView {
        async getHtml() { return ""; }
        async executeScript() {}
    }

    class MapView extends AbstractView {
        async getHtml() {
            return `
                <div class="map-container position-relative">
                    <div id="map" class="h-100"></div>
                    <div class="card position-absolute shadow-lg" style="top: 15px; right: 15px; z-index: 1000; width: 350px;">
                        <div class="card-body">
                            <h5 class="card-title"><i class="fas fa-sliders-h me-2"></i>Analysis Controls</h5>
                            <div id="status-alert" class="alert alert-info" role="alert"><i class="fas fa-info-circle me-2"></i>Click map to select a location.</div>
                            <div class="d-grid gap-2">
                                <button id="detect-btn" class="btn btn-primary" disabled><i class="fas fa-search me-2"></i>Detect Blooms</button>
                            </div>
                        </div>
                    </div>
                </div>`;
        }
        async executeScript() {
            if (!state.isAuthenticated) {
                document.getElementById('main-content').innerHTML = '<div class="container text-center p-5"><h2>Please log in to use the analysis tools.</h2></div>';
                return;
            }
            const map = L.map('map').setView([20, 0], 3);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' }).addTo(map);
            let locationMarker = null, analysisLocation = null, overlayLayer = null;
            const detectBtn = document.getElementById('detect-btn');
            const statusAlert = document.getElementById('status-alert');
            const loadingOverlay = document.getElementById('loading-overlay');

            map.on('click', (e) => {
                analysisLocation = e.latlng;
                if (locationMarker) map.removeLayer(locationMarker);
                locationMarker = L.marker(e.latlng).addTo(map).bindPopup("Selected Location").openPopup();
                statusAlert.className = "alert alert-success";
                statusAlert.innerHTML = `<i class="fas fa-check-circle me-2"></i>Location selected.`;
                detectBtn.disabled = false;
            });

            detectBtn.addEventListener('click', async () => {
                if (!analysisLocation) return;
                loadingOverlay.classList.remove('d-none');
                try {
                    const data = await apiRequest(`/api/analysis/detect?lat=${analysisLocation.lat}&lon=${analysisLocation.lng}`);
                    if (data.success) {
                        if (overlayLayer) map.removeLayer(overlayLayer);
                        overlayLayer = L.imageOverlay(data.data.image_url, data.data.bounds, { opacity: 0.7 }).addTo(map);
                        map.fitBounds(data.data.bounds);
                    }
                } catch (error) {
                    alert(`Analysis failed: ${error.message}`);
                } finally {
                    loadingOverlay.classList.add('d-none');
                }
            });
        }
    }

    class HistoryView extends AbstractView {
        async getHtml() {
            return `<div class="container my-4"><h2><i class="fas fa-history me-2"></i>Analysis History is not yet implemented.</h2></div>`;
        }
    }

    // --- ROUTER ---
    const router = async () => {
        const routes = [{ path: "/", view: MapView }, { path: "/history", view: HistoryView }];
        const match = routes.find(route => location.pathname === route.path) || routes[0];
        const view = new match.view();
        document.getElementById('main-content').innerHTML = await view.getHtml();
        await view.executeScript();
    };

    // --- AUTHENTICATION MANAGER ---
    const AuthManager = {
        async init() {
            try {
                const data = await apiRequest('/api/auth/status');
                state.isAuthenticated = data.data.isAuthenticated;
                state.currentUser = data.data.user;
            } catch {
                state.isAuthenticated = false;
                state.currentUser = null;
            }
            this.render();
            this.setupEventListeners();
            router();
        },
        render() {
            const container = document.getElementById('auth-container');
            if (state.isAuthenticated) {
                container.innerHTML = `
                    <div class="dropdown">
                        <button class="btn btn-outline-light dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user-circle me-1"></i> ${state.currentUser.name}
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="#" id="logout-btn"><i class="fas fa-sign-out-alt me-2"></i>Logout</a></li>
                        </ul>
                    </div>`;
            } else {
                container.innerHTML = `
                    <button class="btn btn-outline-light me-2" data-bs-toggle="modal" data-bs-target="#loginModal">Login</button>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#registerModal">Sign Up</button>`;
            }
        },
        async handleForm(formId, url) {
            const form = document.getElementById(formId);
            const alertEl = form.querySelector('.alert');
            try {
                const formData = new FormData(form);
                const data = Object.fromEntries(formData.entries());
                const result = await apiRequest(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data),
                });
                if (result.success) {
                    bootstrap.Modal.getInstance(form.closest('.modal')).hide();
                    this.init();
                }
            } catch (error) {
                alertEl.textContent = error.message;
                alertEl.classList.remove('d-none');
            }
        },
        setupEventListeners() {
            document.body.addEventListener('submit', e => {
                if (e.target.id === 'loginForm') { e.preventDefault(); this.handleForm('loginForm', '/api/auth/login'); }
                if (e.target.id === 'registerForm') { e.preventDefault(); this.handleForm('registerForm', '/api/auth/register'); }
            });
            document.body.addEventListener('click', e => {
                if (e.target.id === 'logout-btn') { e.preventDefault(); this.logout(); }
                if (e.target.matches('[data-link]')) { e.preventDefault(); navigateTo(e.target.href); }
            });
        },
        async logout() {
            await apiRequest('/api/auth/logout', { method: 'POST' });
            this.init();
        }
    };

    window.addEventListener('popstate', router);
    AuthManager.init();
});
</script>
{% endblock %}