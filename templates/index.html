{% extends "layout.html" %}

{% block title %}Advanced Water Analysis Dashboard{% endblock %}

{% block content %}
<nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow-sm">
    <div class="container-fluid">
        <a class="navbar-brand" href="/" data-link><i class="fas fa-water me-2"></i>AquaVision AI</a>
        <div id="auth-container">
            </div>
    </div>
</nav>

<div class="content-wrapper" id="main-content">
    </div>

{% include 'auth_modals.html' %}

<footer class="footer mt-auto py-2 bg-dark text-white text-center">
    <div class="container">
        <span>A Portfolio Project by Pal Ghevariya | <a href="#" data-bs-toggle="modal" data-bs-target="#contactModal" class="text-white">Contact Me</a></span>
    </div>
</footer>

<div class="modal fade" id="contactModal" tabindex="-1">
    <div class="modal-dialog"><div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Contact Information</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body"><p>For inquiries, please reach out via email: <a href="mailto:palghevariya654@gmail.com">palghevariya654@gmail.com</a></p></div>
    </div></div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Main script for the Single Page Application
document.addEventListener('DOMContentLoaded', () => {
    const state = { currentUser: null, isAuthenticated: false };
    const mainContent = document.getElementById('main-content');
    const MaptilerApiKey = 'YOUR_MAPTILER_API_KEY'; // IMPORTANT: Get a free key from MapTiler.com

    const navigateTo = url => {
        history.pushState(null, null, url);
        router();
    };

    const router = async () => {
        const path = location.pathname;
        let view;

        if (path === "/") view = new MapView();
        else if (path === "/history") view = new HistoryView();
        else if (path === "/api-key") view = new ApiKeyView();
        else if (path.startsWith("/reset-password/")) view = new ResetPasswordView();
        else {
            navigateTo("/");
            return;
        }

        mainContent.innerHTML = await view.getHtml();
        await view.executeScript();
    };
    
    window.addEventListener("popstate", router);
    document.body.addEventListener("click", e => {
        if (e.target.closest("[data-link]")) {
            e.preventDefault();
            navigateTo(e.target.closest("[data-link]").href);
        }
    });

    class AbstractView {
        async getHtml() { return ""; }
        async executeScript() {}
    }

    class MapView extends AbstractView {
        async getHtml() { return `...`; } // Omitted for brevity - same as previous response
        async executeScript() { /* ... Same as previous response ... */ }
    }

    class HistoryView extends AbstractView {
        async getHtml() { return `...`; } // Omitted for brevity - same as previous response
        async executeScript() { /* ... Same as previous response ... */ }
    }
    
    class ApiKeyView extends AbstractView {
        async getHtml() { 
            // Logic to fetch API key from backend
            return `<div class="container my-4"><h2>Your API Key</h2>...</div>`;
        }
        async executeScript() { /* ... Same as previous response ... */ }
    }

    class ResetPasswordView extends AbstractView {
        async getHtml() {
            const token = location.pathname.split('/').pop();
            return `
                <div class="container my-5" style="max-width: 500px;">
                    <h2>Reset Your Password</h2>
                    <form id="resetPasswordForm">
                        <div class="alert alert-danger d-none"></div>
                        <input type="hidden" name="token" value="${token}">
                        <div class="mb-3"><label for="password" class="form-label">New Password</label><input type="password" name="password" class="form-control" required></div>
                        <button type="submit" class="btn btn-primary">Update Password</button>
                    </form>
                </div>`;
        }
        async executeScript() {
            document.getElementById('resetPasswordForm').addEventListener('submit', async e => {
                e.preventDefault();
                const form = e.target;
                const data = Object.fromEntries(new FormData(form).entries());
                const res = await fetch('/api/auth/reset_password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                if(result.success) {
                    alert(result.message);
                    navigateTo('/');
                    initializeApp();
                } else {
                    form.querySelector('.alert').textContent = result.error;
                    form.querySelector('.alert').classList.remove('d-none');
                }
            });
        }
    }

    const renderAuthUI = () => { /* ... Same as previous response ... */ };
    const handleFormSubmit = async (formId, url, modalId) => { /* ... Same as previous response ... */ };
    
    const initializeApp = async () => {
        const res = await fetch('/api/auth/status');
        if(res.ok) {
            const data = await res.json();
            if(data.isAuthenticated) {
                state.isAuthenticated = true;
                state.currentUser = data.user;
            }
        }
        
        renderAuthUI();
        handleFormSubmit('loginForm', '/api/auth/login', 'loginModal');
        handleFormSubmit('registerForm', '/api/auth/register', 'registerModal');
        
        document.getElementById('forgotPasswordForm')?.addEventListener('submit', async e => {
            e.preventDefault();
            const data = Object.fromEntries(new FormData(e.target).entries());
            await fetch('/api/auth/forgot_password', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email: data.email })
            });
            alert('If an account with that email exists, a password reset link has been sent.');
            bootstrap.Modal.getInstance(e.target.closest('.modal')).hide();
        });
        
        router();
    };

    initializeApp();
});
</script>
{% endblock %}