{% extends "layout.html" %}

{% block title %}Advanced Water Analysis Dashboard{% endblock %}

{% block content %}
<nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm">
    <div class="container-fluid">
        <a class="navbar-brand d-flex align-items-center" href="/" data-link>
            <i class="fas fa-water me-2"></i>
            <span class="d-none d-sm-inline">AquaVision</span>
            <span class="badge bg-light text-primary ms-2">AI</span>
        </a>
        
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarMain">
            <span class="navbar-toggler-icon"></span>
        </button>
        
        <div class="collapse navbar-collapse" id="navbarMain">
            <ul class="navbar-nav me-auto">
                <li class="nav-item">
                    <a class="nav-link" href="/" data-link>Map</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/history" data-link>History</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/api-key" data-link>API</a>
                </li>
            </ul>
            
            <div id="auth-container" class="d-flex align-items-center"></div>
        </div>
    </div>
</nav>

<div class="content-wrapper" id="main-content">
    <!-- Dynamic content will be loaded here -->
    <div class="container-fluid py-4">
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    </div>
</div>

{% include 'auth_modals.html' %}
{% include 'notifications.html' %}

<footer class="footer mt-auto py-3 bg-dark text-white">
    <div class="container">
        <div class="row">
            <div class="col-md-6 text-center text-md-start">
                <span>&copy; 2023 AquaVision AI. All rights reserved.</span>
            </div>
            <div class="col-md-6 text-center text-md-end">
                <a href="#" class="text-white me-3" data-bs-toggle="modal" data-bs-target="#termsModal">Terms</a>
                <a href="#" class="text-white me-3" data-bs-toggle="modal" data-bs-target="#privacyModal">Privacy</a>
                <a href="#" class="text-white" data-bs-toggle="modal" data-bs-target="#contactModal">Contact</a>
            </div>
        </div>
    </div>
</footer>

<!-- Additional Modals -->
<div class="modal fade" id="contactModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Contact Us</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>For inquiries, please reach out via email:</p>
                <p><a href="mailto:support@aquavision.ai">support@aquavision.ai</a></p>
            </div>
        </div>
    </div>
</div>

<!-- Loading overlay -->
<div id="loading-overlay" class="position-fixed top-0 start-0 w-100 h-100 bg-dark bg-opacity-75 d-flex justify-content-center align-items-center d-none" style="z-index: 1100;">
    <div class="text-center text-white">
        <div class="spinner-border" style="width: 3rem; height: 3rem;" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <h4 class="mt-3">Processing Analysis...</h4>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Modern JavaScript with ES6 classes and modules
document.addEventListener('DOMContentLoaded', () => {
    class AppState {
        constructor() {
            this.currentUser = null;
            this.isAuthenticated = false;
            this.pendingRequests = 0;
        }
        
        setUser(user) {
            this.currentUser = user;
            this.isAuthenticated = !!user;
        }
    }

    class AuthManager {
        constructor() {
            this.state = new AppState();
            this.initAuthUI();
            this.setupInterceptors();
        }
        
        initAuthUI() {
            const authContainer = document.getElementById('auth-container');
            if (this.state.isAuthenticated) {
                authContainer.innerHTML = `
                    <div class="dropdown">
                        <button class="btn btn-outline-light dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user-circle me-1"></i>
                            ${this.state.currentUser.name}
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="/api-key" data-link><i class="fas fa-key me-2"></i>API Key</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" id="logout-btn"><i class="fas fa-sign-out-alt me-2"></i>Logout</a></li>
                        </ul>
                    </div>
                `;
                document.getElementById('logout-btn').addEventListener('click', this.logout.bind(this));
            } else {
                authContainer.innerHTML = `
                    <button class="btn btn-outline-light me-2" data-bs-toggle="modal" data-bs-target="#loginModal">
                        Login
                    </button>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#registerModal">
                        Sign Up
                    </button>
                `;
            }
        }
        
        async checkAuthStatus() {
            try {
                const response = await fetch('/api/auth/status');
                if (response.ok) {
                    const data = await response.json();
                    this.state.setUser(data.user);
                    this.initAuthUI();
                }
            } catch (error) {
                console.error('Auth check failed:', error);
            }
        }
        
        async logout() {
            try {
                await fetch('/api/auth/logout', { method: 'POST' });
                this.state.setUser(null);
                this.initAuthUI();
                window.location.href = '/';
            } catch (error) {
                console.error('Logout failed:', error);
            }
        }
        
        setupInterceptors() {
            const originalFetch = window.fetch;
            window.fetch = async (resource, config = {}) => {
                this.state.pendingRequests++;
                document.getElementById('loading-overlay').classList.remove('d-none');
                
                try {
                    // Add auth token if available
                    if (this.state.isAuthenticated) {
                        config.headers = {
                            ...config.headers,
                            'Authorization': `Bearer ${this.state.currentUser.api_key}`
                        };
                    }
                    
                    const response = await originalFetch(resource, config);
                    
                    // Handle 401 unauthorized
                    if (response.status === 401) {
                        this.state.setUser(null);
                        this.initAuthUI();
                        window.location.href = '/';
                        return Promise.reject(new Error('Unauthorized'));
                    }
                    
                    return response;
                } finally {
                    this.state.pendingRequests--;
                    if (this.state.pendingRequests <= 0) {
                        document.getElementById('loading-overlay').classList.add('d-none');
                    }
                }
            };
        }
    }

    // Initialize the application
    const authManager = new AuthManager();
    authManager.checkAuthStatus();

    // Router implementation
    class Router {
        constructor() {
            this.routes = {
                '/': MapView,
                '/history': HistoryView,
                '/api-key': ApiKeyView,
                '/reset-password/:token': ResetPasswordView
            };
            
            window.addEventListener('popstate', () => this.route());
            document.body.addEventListener('click', this.handleLinkClick.bind(this));
            this.route();
        }
        
        handleLinkClick(event) {
            if (event.target.closest('[data-link]')) {
                event.preventDefault();
                const url = event.target.closest('[data-link]').href;
                history.pushState(null, null, url);
                this.route();
            }
        }
        
        async route() {
            const path = window.location.pathname;
            const mainContent = document.getElementById('main-content');
            
            // Find matching route
            let ViewClass = this.routes['/']; // Default to home
            let params = {};
            
            for (const [route, view] of Object.entries(this.routes)) {
                if (route.includes(':')) {
                    const routeParts = route.split('/');
                    const pathParts = path.split('/');
                    
                    if (routeParts.length === pathParts.length) {
                        let match = true;
                        const currentParams = {};
                        
                        for (let i = 0; i < routeParts.length; i++) {
                            if (routeParts[i].startsWith(':')) {
                                currentParams[routeParts[i].substring(1)] = pathParts[i];
                            } else if (routeParts[i] !== pathParts[i]) {
                                match = false;
                                break;
                            }
                        }
                        
                        if (match) {
                            ViewClass = view;
                            params = currentParams;
                            break;
                        }
                    }
                } else if (route === path) {
                    ViewClass = view;
                    break;
                }
            }
            
            // Render the view
            const view = new ViewClass();
            mainContent.innerHTML = await view.getHtml();
            await view.executeScript(params);
        }
    }

    // View classes would be defined here (MapView, HistoryView, etc.)
    // Similar to previous implementation but with more features
    
    // Initialize router
    new Router();
});
</script>
{% endblock %}