{% extends "layout.html" %}

{% block title %}Water Analysis Dashboard{% endblock %}

{% block content %}
<div class="container-fluid p-0 position-relative" style="height: calc(100vh - 56px - 60px);">
    <div id="map"></div>
    
    <div class="card analysis-card position-absolute shadow" style="top: 15px; right: 15px; z-index: 1000; width: 350px;">
        <div class="card-body">
            <h5 class="card-title"><i class="fas fa-sliders-h me-2"></i>Analysis Controls</h5>
            <div class="mb-3">
                <label for="locationSearch" class="form-label small">Search or click map:</label>
                <input type="text" class="form-control" id="locationSearch" placeholder="Search location...">
            </div>
            <div id="status-alert" class="alert alert-info" role="alert">
                <i class="fas fa-info-circle me-2"></i>Locating you...
            </div>
            <div class="d-grid gap-2 mb-3">
                <button id="detect-btn" class="btn btn-primary" disabled>
                    <i class="fas fa-search me-2"></i>Detect Current Blooms
                </button>
                <button id="predict-btn" class="btn btn-warning" disabled>
                    <i class="fas fa-chart-line me-2"></i>Predict Future Hotspots
                </button>
                <button id="history-btn" class="btn btn-info" disabled>
                    <i class="fas fa-history me-2"></i>View Historical Data
                </button>
            </div>
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="notificationToggle" checked>
                <label class="form-check-label small" for="notificationToggle">Enable alerts for this area</label>
            </div>
        </div>
    </div>

    <div class="position-absolute p-2 legend shadow" style="bottom: 20px; left: 10px; z-index: 1000; background: white; border-radius: 5px;">
        <h6 class="mb-2"><i class="fas fa-map-legend me-2"></i>Legend</h6>
        <div><span style="background-color: rgba(255,0,0,0.5); width: 18px; height: 18px; float: left; margin-right: 8px;"></span> Current Bloom</div>
        <div><span style="background-color: rgba(255,255,0,0.5); width: 18px; height: 18px; float: left; margin-right: 8px;"></span> Predicted Risk</div>
        <div><span style="background-color: rgba(0,0,255,0.5); width: 18px; height: 18px; float: left; margin-right: 8px;"></span> Historical Data</div>
    </div>
</div>

<div class="modal fade" id="loadingModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center py-4">
                <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <h5 id="loading-text">Analyzing satellite data...</h5>
                <div class="progress mt-3" style="height: 6px;">
                    <div id="analysisProgress" class="progress-bar progress-bar-striped progress-bar-animated" style="width: 0%"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="historyModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="historyModalTitle">Historical Analysis</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <canvas id="bloomTrendChart"></canvas>
                    </div>
                    <div class="col-md-6">
                        <canvas id="severityChart"></canvas>
                    </div>
                </div>
                <div class="mt-3">
                    <h6>Historical Timeline</h6>
                    <div class="timeline">
                        </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="exportHistoryBtn">
                    <i class="fas fa-download me-2"></i>Export Data
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Enhanced Main Map Script
    const map = L.map('map', {
        zoomControl: false,
        preferCanvas: true
    });
    
    // Add zoom control with custom position
    L.control.zoom({
        position: 'topright'
    }).addTo(map);

    const detectBtn = document.getElementById('detect-btn');
    const predictBtn = document.getElementById('predict-btn');
    const historyBtn = document.getElementById('history-btn');
    const statusAlert = document.getElementById('status-alert');
    const loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'), { keyboard: false, backdrop: 'static' });
    const loadingText = document.getElementById('loading-text');
    const analysisProgress = document.getElementById('analysisProgress');

    // THIS IS THE LINE THAT WAS FIXED (bootstrap.modal -> bootstrap.Modal)
    const historyModal = new bootstrap.Modal(document.getElementById('historyModal'));
    
    const notificationToastEl = document.getElementById('notificationToast');
    const notificationToast = notificationToastEl ? new bootstrap.Toast(notificationToastEl) : null;
    const locationSearch = document.getElementById('locationSearch');

    let analysisLocation = null;
    let locationMarker = null;
    let bloomLayer = null;
    let predictionLayer = null;
    let historicalLayer = null;
    let bloomTrendChart = null;
    let severityChart = null;

    // Base Maps
    const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Tiles &copy; Esri'
    });

    const topographic = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
        attribution: 'Map data: &copy; OpenTopoMap'
    });

    const streetMap = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    });

    const baseMaps = {
        "Satellite": satellite,
        "Topographic": topographic,
        "Street Map": streetMap
    };

    // Overlay Layers
    const bloomOverlays = {
        "Current Blooms": bloomLayer,
        "Predictions": predictionLayer,
        "Historical Data": historicalLayer
    };

    // Initialize map with satellite base layer
    satellite.addTo(map);
    L.control.layers(baseMaps, bloomOverlays, { position: 'bottomright' }).addTo(map);

    // Location search autocomplete
    const searchAutoComplete = new autoComplete({
        selector: "#locationSearch",
        placeHolder: "Search location...",
        data: {
            src: async (query) => {
                try {
                    const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${query}`);
                    return await response.json();
                } catch (error) {
                    return [];
                }
            },
            keys: ["display_name"],
            cache: true
        },
        resultsList: {
            element: (list, data) => {
                if (!data.results.length) {
                    const message = document.createElement("div");
                    message.setAttribute("class", "no_result");
                    message.innerHTML = `<span>No results found for "${data.query}"</span>`;
                    list.prepend(message);
                }
            },
            noResults: true,
            maxResults: 5,
        },
        resultItem: {
            element: (item, data) => {
                item.style = "display: flex; justify-content: space-between;";
                item.innerHTML = `
                    <span style="text-overflow: ellipsis; white-space: nowrap; overflow: hidden;">
                        ${data.match}
                    </span>
                    <span style="display: flex; align-items: center; font-size: 13px; font-weight: 400; text-transform: uppercase; color: grey;">
                        ${data.value.type}
                    </span>`;
            },
            highlight: true
        },
        events: {
            input: {
                selection: (event) => {
                    const selection = event.detail.selection.value;
                    const lat = parseFloat(selection.lat);
                    const lon = parseFloat(selection.lon);
                    map.setView([lat, lon], 12);
                    updateLocation(lat, lon, selection.display_name);
                    locationSearch.value = selection.display_name;
                }
            }
        }
    });

    // Map click handler
    map.on('click', (e) => {
        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${e.latlng.lat}&lon=${e.latlng.lon}`)
            .then(response => response.json())
            .then(data => {
                const locationName = data.display_name || "Selected Location";
                updateLocation(e.latlng.lat, e.latlng.lng, locationName);
                locationSearch.value = locationName;
            })
            .catch(() => {
                updateLocation(e.latlng.lat, e.latlng.lng, "Selected Location");
                locationSearch.value = `${e.latlng.lat.toFixed(4)}, ${e.latlng.lng.toFixed(4)}`;
            });
    });

    // Update location function
    function updateLocation(lat, lon, message) {
        analysisLocation = { lat, lon };
        
        if (locationMarker) {
            map.removeLayer(locationMarker);
        }
        
        locationMarker = L.marker([lat, lon], {
            icon: L.divIcon({
                className: 'location-marker',
                html: '<i class="fas fa-map-marker-alt" style="color: #0d6efd; font-size: 32px;"></i>',
                iconSize: [32, 32],
                iconAnchor: [16, 32]
            })
        }).addTo(map);
        
        locationMarker.bindPopup(`<b>${message}</b><br>Lat: ${lat.toFixed(4)}, Lon: ${lon.toFixed(4)}`).openPopup();
        setButtonsState(false);
        setStatus(`<i class="fas fa-check-circle me-2"></i>Location selected: ${message}`, "success");
        
        if (document.getElementById('notificationToggle').checked) {
            showNotification(`Monitoring location set: ${message}`);
        }
    }

    // Run analysis function
    function runAnalysis(endpoint, loadingMessage) {
        if (!analysisLocation) return;
        
        setButtonsState(true);
        loadingText.innerHTML = loadingMessage;
        analysisProgress.style.width = '0%';
        loadingModal.show();
        
        let progress = 0;
        const progressInterval = setInterval(() => {
            progress += Math.random() * 10;
            if (progress > 90) progress = 90;
            analysisProgress.style.width = `${progress}%`;
        }, 300);
        
        const url = `/${endpoint}?lat=${analysisLocation.lat}&lon=${analysisLocation.lon}`;
        
        fetch(url)
            .then(res => res.json())
            .then(data => {
                clearInterval(progressInterval);
                analysisProgress.style.width = '100%';
                
                setTimeout(() => {
                    loadingModal.hide();
                    if (data.success) {
                        addImageOverlay(data, endpoint);
                        setStatus(`<i class="fas fa-check-circle me-2"></i>${endpoint.charAt(0).toUpperCase() + endpoint.slice(1)} complete!`, 'success');
                        showNotification(`${endpoint.charAt(0).toUpperCase() + endpoint.slice(1)} analysis completed.`);
                    } else {
                        setStatus(`<i class="fas fa-exclamation-triangle me-2"></i>Error: ${data.error}`, 'danger');
                    }
                    setButtonsState(false);
                }, 500);
            })
            .catch(err => {
                clearInterval(progressInterval);
                loadingModal.hide();
                setStatus(`<i class="fas fa-exclamation-triangle me-2"></i>A network error occurred.`, 'danger');
                setButtonsState(false);
            });
    }

    // Add image overlay to map
    function addImageOverlay(data, type) {
        const layerMap = {
            'detect': { layer: bloomLayer, name: "Current Blooms" },
            'predict': { layer: predictionLayer, name: "Predictions" }
        };

        const existingLayerInfo = layerMap[type];
        if (existingLayerInfo && existingLayerInfo.layer) {
            map.removeLayer(existingLayerInfo.layer);
        }

        const newOverlay = L.imageOverlay(data.image_url, data.bounds, {
            opacity: 0.7,
            interactive: true
        }).addTo(map);

        if (type === 'detect') bloomLayer = newOverlay;
        if (type === 'predict') predictionLayer = newOverlay;

        updateLayerControl();
    }
    
    function updateLayerControl() {
        if (map.layersControl) {
            map.removeControl(map.layersControl);
        }
        
        const activeOverlays = {};
        if (bloomLayer) activeOverlays["Current Blooms"] = bloomLayer;
        if (predictionLayer) activeOverlays["Predictions"] = predictionLayer;
        if (historicalLayer) activeOverlays["Historical Data"] = historicalLayer;
        
        map.layersControl = L.control.layers(baseMaps, activeOverlays, { position: 'bottomright' }).addTo(map);
    }

    // Show notification toast
    function showNotification(message) {
        if (!notificationToast) return;
        const toastBody = document.querySelector('#notificationToast .toast-body');
        toastBody.innerHTML = message;
        notificationToast.show();
    }

    // Set status message
    function setStatus(message, type = 'info') {
        statusAlert.className = `alert alert-${type} d-flex align-items-center`;
        statusAlert.innerHTML = message;
    }
    
    // Set buttons state
    function setButtonsState(disabled) {
        detectBtn.disabled = disabled;
        predictBtn.disabled = disabled;
        historyBtn.disabled = disabled;
    }

    // Historical data button handler
    historyBtn.addEventListener('click', () => {
        if (!analysisLocation) return;
        
        loadingText.innerHTML = "Loading historical data...";
        loadingModal.show();
        
        fetch(`/history-data?lat=${analysisLocation.lat}&lon=${analysisLocation.lon}`)
            .then(res => res.json())
            .then(data => {
                loadingModal.hide();
                if (data.success) {
                    displayHistoricalData(data);
                    historyModal.show();
                } else {
                    setStatus(`<i class="fas fa-exclamation-triangle me-2"></i>${data.error}`, 'danger');
                }
            })
            .catch(err => {
                loadingModal.hide();
                setStatus(`<i class="fas fa-exclamation-triangle me-2"></i>Failed to load history`, 'danger');
            });
    });

    // Display historical data in modal
    function displayHistoricalData(data) {
        document.getElementById('historyModalTitle').textContent = `Historical Analysis: ${data.location_name}`;
        
        if (bloomTrendChart) bloomTrendChart.destroy();
        const trendCtx = document.getElementById('bloomTrendChart').getContext('2d');
        bloomTrendChart = new Chart(trendCtx, { /* ... chart config ... */ });
        
        if (severityChart) severityChart.destroy();
        const severityCtx = document.getElementById('severityChart').getContext('2d');
        severityChart = new Chart(severityCtx, { /* ... chart config ... */ });
        
        const timeline = document.querySelector('.timeline');
        timeline.innerHTML = '';
        data.timeline.forEach(item => {
            const timelineItem = document.createElement('div');
            timelineItem.className = 'timeline-item mb-3';
            timelineItem.innerHTML = `...`; // Dynamic content
            timeline.appendChild(timelineItem);
        });
    }

    // Initialize with user location or default
    navigator.geolocation.getCurrentPosition(
        pos => {
            const { latitude: lat, longitude: lon } = pos.coords;
            map.setView([lat, lon], 12);
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`)
                .then(response => response.json())
                .then(data => {
                    const name = data.display_name || "Your Location";
                    updateLocation(lat, lon, name);
                    locationSearch.value = name;
                })
                .catch(() => {
                    updateLocation(lat, lon, "Your Location");
                    locationSearch.value = `${lat.toFixed(4)}, ${lon.toFixed(4)}`;
                });
        },
        () => {
            const lat = 21.17, lon = 72.83; // Surat, India
            map.setView([lat, lon], 12);
            updateLocation(lat, lon, "Default Location (Surat, India)");
            locationSearch.value = "Surat, India";
            setStatus(`<i class="fas fa-exclamation-triangle me-2"></i>Could not get location. Using default.`, "warning");
        }
    );

    // Event listeners
    detectBtn.addEventListener('click', () => runAnalysis('detect', 'Detecting current algal blooms...'));
    predictBtn.addEventListener('click', () => runAnalysis('predict', 'Predicting future bloom hotspots...'));
    document.getElementById('exportHistoryBtn').addEventListener('click', () => {
        showNotification('Export functionality is not yet implemented.');
    });
</script>
{% endblock %}